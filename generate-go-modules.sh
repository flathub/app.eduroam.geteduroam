#! /bin/sh

set -ex

mkdir -p go-modules && pushd go-modules

git clone --depth=1 "--branch=$1" https://github.com/geteduroam/linux-app.git
go run github.com/dennwc/flatpak-go-mod@v0.1.0 ./linux-app
rm -rf linux-app

popd

cp go-modules/modules.txt .

MODULES_START=$(grep '################# Auto generated by github.com/dennwc/flatpak-go-mod ################' app.eduroam.geteduroam.yml -n | head -n1 | cut -d ':' -f 1)
head app.eduroam.geteduroam.yml "-n $MODULES_START"       > app.eduroam.geteduroam.yml.new
sed  go-modules/go.mod.yml -e "s#^#      #" | tail -n+2 >> app.eduroam.geteduroam.yml.new
tail app.eduroam.geteduroam.yml -n1                       >> app.eduroam.geteduroam.yml.new
mv   app.eduroam.geteduroam.yml.new app.eduroam.geteduroam.yml

rm -rf go-modules
